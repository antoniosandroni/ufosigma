_: &all_channels 1-1953

_: &all_selected_channels 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 
                          21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 
                          39, 40, 41, 43, 44, 45, 46, 47, 49, 52, 54, 56, 57, 58, 59, 60, 63, 64, 
                          65, 66, 67, 68, 69, 70, 73, 82, 83, 84, 85, 86, 87, 90, 91, 92, 95, 96, 97, 101, 
                          102, 103, 104, 105, 106, 108, 109, 111, 114, 115, 116, 121, 122, 124, 125, 126, 127, 
                          129, 131, 141, 147, 149, 152, 160, 161, 162, 166, 169, 173, 174, 175, 176, 187, 188, 189, 
                          190, 192, 194, 195, 197, 198, 199, 200, 202, 204, 206, 207, 208, 210, 214, 222, 224, 242, 
                          245, 267, 268, 281, 284, 286, 287, 288, 289, 320, 331, 345, 377, 388, 439, 514, 529, 531, 
                          533, 536, 538, 540, 542, 543, 544, 548, 549, 550, 556, 561, 562, 568, 569, 570, 572, 573, 
                          574, 576, 577, 578, 579, 580, 581, 582, 583, 584, 586, 587, 588, 589, 590, 592, 593, 594, 
                          595, 596, 597, 598, 599, 600, 601, 602, 606, 609, 611, 614, 615, 616, 617, 618, 619, 620, 
                          621, 623, 624, 625, 626, 627, 628, 629, 630, 631, 632, 633, 634, 635, 636, 637, 638, 639, 
                          640, 641, 642, 643, 656, 683, 691, 709, 713, 717, 733, 746, 757, 761, 784, 806, 820, 821, 
                          822, 823, 825, 841, 842, 844, 859, 862, 886, 890, 892, 896, 898, 900, 901, 908, 909, 911, 
                          912, 920, 921, 923, 924, 926, 927, 928, 932, 938, 939, 940, 941, 942, 943, 946, 951, 954, 
                          955, 956, 957, 960, 961, 962, 966, 968, 972, 974, 987, 991, 992, 996, 999, 1007, 1022, 1040, 
                          1041, 1054, 1057, 1058, 1075, 1664, 1800, 1930, 1949

# Base channels for the 1dvar
_: &1dvarchannels 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 
                  21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 
                  39, 40, 41, 43, 44, 45, 46, 47, 49, 52, 54, 56, 57, 58, 59, 60, 63, 64, 
                  65, 66, 67, 68, 69, 70, 73, 82, 83, 84, 85, 86, 87, 90, 91, 92, 95, 96, 97, 101, 
                  102, 103, 104, 105, 106, 108, 109, 111, 114, 115, 116, 121, 122, 124, 125, 126, 127, 
                  129, 131, 141, 147, 149, 152, 160, 161, 162, 166, 169, 173, 174, 175, 176, 187, 188, 189, 
                  190, 192, 194, 195, 197, 198, 199, 200, 202, 204, 206, 207, 208, 210, 214, 222, 224, 242, 
                  245, 267, 268, 281, 284, 286, 287, 288, 289, 320, 331, 345, 377, 388, 439, 514, 529, 
                  656, 683, 691, 709, 713, 717, 733, 746, 757, 761, 784, 806, 820, 821, 
                  822, 823, 825, 841, 842, 844, 859, 862, 886, 890, 892, 896, 898, 900, 901, 908, 909, 911, 
                  912, 920, 921, 923, 924, 926, 927, 928, 932, 938, 939, 940, 941, 942, 943, 946, 951, 954, 
                  955, 956, 957, 960, 961, 962, 968, 972, 974, 987, 991, 992, 996, 999, 1007, 1022, 1040, 
                  1041, 1054, 1057, 1058, 1075

# Channels not used in the 1dvar
# Ozone sensitivity - 531 to 643
# channel 966 (1653.15782 cm-1) removed as long tail in water vapour jacobian
# channels with wvn > 2000 cm-1 (corresponding to IASI band 3): 1664, 1800, 1930, 1949
_: &1dvar_not_used 531, 533, 536, 538, 540, 542, 543, 544, 548, 549, 550, 556, 561, 562, 568, 569, 570, 572, 573, 
                    574, 576, 577, 578, 579, 580, 581, 582, 583, 584, 586, 587, 588, 589, 590, 592, 593, 594, 
                    595, 596, 597, 598, 599, 600, 601, 602, 606, 609, 611, 614, 615, 616, 617, 618, 619, 620, 
                    621, 623, 624, 625, 626, 627, 628, 629, 630, 631, 632, 633, 634, 635, 636, 637, 638, 639, 
                    640, 641, 642, 643, 966, 1664, 1800, 1930, 1949

time window:
  begin: 2021-06-24T09:00:00Z
  end: 2021-06-24T15:00:00Z

observations:
- obs operator: &ObsOperator
    name: RTTOV
    Absorbers: &rttov_absorbers [Ozone]
    obs options: &rttov_options
      RTTOV_default_opts: UKMO_PS45
      SatRad_compatibility: true
      WMO_ID: &wmo_id [72]
      Sat_ID: &sat_id [mtg_2]
      Instrument_Name: &instrument_id IRS
      CoefficientPath: &coefpath Data/
      RTTOV_GasUnitConv: &gasunitconv true
      UseRHwaterForQC: &UseRHwaterForQC true
      UseColdSurfaceCheck: &UseColdSurfaceCheck false
      RTTOV_ScaleRefOzone: &RTTOV_ScaleRefOzone true
      RTTOV_clw_data: false
      RTTOV_profile_checkinput: true
      # use CAMEL emissivity atlas:
      UseSurfaceEmissivityAtlas: true
      SurfaceEmissivityAtlasName: CAMELClim
      SurfaceEmissivityAtlasPath: Data/
      ReconstructedRadianceCorrection: true
      CMatrixPath: Data/ufo/testinput_tier_1/resources/auxillary/mtgirs_cmatrix_and_bias
      RTTOV_switchrad: false # use radiance as input
  obs space: &ObsSpace
    name: Test the bespoke operator for MTGIRS reconstructed radiances
    obsdatain:
      engine:
        type: H5File
        obsfile: Data/ufo/testinput_tier_1/mtgirs_202106241200_5obs.nc4
    observed variables: [radiance]
    simulated variables: [brightnessTemperature]
    derived variables: [brightnessTemperature]
    channels: *all_channels
#    obsdataout:
#      engine:
#        type: H5File
#        obsfile: Data/mtgirs_202106241200_reconrad_obsop_out.nc4
  geovals: &GeoVaLs
    filename: Data/ufo/testinput_tier_1/mtgirs_geovals_202106241200_5locs.nc4
  obs filters:
### RejectList ###
  - filter: RejectList
    filter variables:
    - name: brightnessTemperature
      channels: *1dvar_not_used
    ### Assign error from file
  - filter: Perform Action
    filter variables:
    - name: brightnessTemperature
      channels: *all_channels
    action:
      name: assign error
      error function:
        name: ObsFunction/DrawObsErrorFromFile
        channels: *all_channels
        options:
          file:  Data/ufo/testinput_tier_1/resources/rmatrix/rttov/mtgirs_obserror_fstest.nc4
          group: ObsError
          dispersion measure: standard deviation
          channels: *all_channels
          interpolation:
          - name: MetaData/satelliteIdentifier
            method: exact
### 1D-Var check ###
  - filter: RTTOV OneDVar Check
    ModOptions:
      Absorbers: *rttov_absorbers
      obs options:
        RTTOV_default_opts: UKMO_PS45
        SatRad_compatibility: false # done in filter
        RTTOV_GasUnitConv: *gasunitconv
        UseRHwaterForQC: false
        UseColdSurfaceCheck: false
        RTTOV_ScaleRefOzone: *RTTOV_ScaleRefOzone
        WMO_ID: *wmo_id
        Sat_ID: *sat_id
        Instrument_Name: *instrument_id
        CoefficientPath: *coefpath
        RTTOV_clw_data: false
        ReconstructedRadianceCorrection: true
        CMatrixPath: Data/ufo/testinput_tier_1/resources/auxillary/mtgirs_cmatrix_and_bias
        RTTOV_switchrad: false # use radiance as input
        #InspectProfileNumber: [1]
    BMatrix:  Data/ufo/testinput_tier_1/resources/bmatrix/rttov/mtgirs_bmatrix_70_test.dat
    RMatrix:  Data/ufo/testinput_tier_1/resources/rmatrix/rttov/mtgirs_s1_rmatrix_fstest.nc4
    filter variables:
    - name: brightnessTemperature
      channels: *all_channels
    retrieval variables from geovals:
    - air_temperature # 1
    - water_vapor_mixing_ratio_wrt_moist_air  # 2
    - air_temperature_at_2m # 3
    - water_vapor_mixing_ratio_wrt_moist_air_at_2m # 4
    - skin_temperature_at_surface # 5
    - air_pressure_at_surface # 6
    retrieval variables not from geovals:
    - cloud_top_pressure # 16
    - cloud_fraction # 17
    - emissivity_pc # 18
    nlevels: 70
    UseMLMinimization: true
    DoCloudyChannelRejection: true
    defer to post: true
    Max1DVarIterations: 10
    MaxMLIterations: 10
    SkinTempErrorLand: 5.0
    surface emissivity:
      type: principalcomponent
      group in obs space: AtlasEmiss
      EmisEigVecPath:  Data/ufo/testinput_tier_1/resources/auxillary/mtgirs_emis_eigen_vec_fstest
    RecalculateBT: true
    RetrievedErrorFactor: -1.0
  passedBenchmark: 380
  #passedBenchmark: 344 # with ReconstructedRadianceCorrection: false
